name: Build and Push to Aliyun ACR

on:
  push:
    branches:
      - main  # 每次推送 main 分支时触发
  workflow_dispatch: # 也可以手动触发

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 拉取最新代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ 设置 JDK 环境（适用于 Spring Boot 项目）
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3️⃣ 使用 Maven 构建项目
      - name: Build jar
        run: |
          chmod +x mvnw || true
          ./mvnw clean package -DskipTests

      # 4️⃣ 登录阿里云容器镜像服务（ACR）
      - name: Log in to Aliyun ACR
        run: |
          echo "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}" | docker login \
            --username=${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            --password-stdin ${{ secrets.ALIYUN_REGISTRY }}

      # 5️⃣ 构建 Docker 镜像并推送到 ACR
      - name: Build and Push Docker image
        run: |
          IMAGE=${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ secrets.ALIYUN_REPO }}:$(date +%Y%m%d%H%M%S)
          echo "Building image: $IMAGE"
          docker build -t $IMAGE .
          docker push $IMAGE

      # 6️⃣ （可选）标记 latest 标签
      - name: Tag and Push latest
        run: |
          LATEST=${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ secrets.ALIYUN_REPO }}:latest
          IMAGE=${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ secrets.ALIYUN_REPO }}:$(date +%Y%m%d%H%M%S)
          docker tag $IMAGE $LATEST
          docker push $LATEST
