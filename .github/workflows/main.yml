name: Java CI with SNYK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  setup-build:
    name: Setup & Build
    runs-on: ubuntu-latest
    env:
      SPRING_PROFILES_ACTIVE: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven repository
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build project (skip tests)
        run: mvn clean verify -DskipTests

  lint-check:
    name: Lint Check (Checkstyle)
    runs-on: ubuntu-latest
    needs: setup-build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Checkstyle Lint
        run: mvn checkstyle:checkstyle

      - name: Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/site/checkstyle.html

  snyk-sca:
    name: Snyk SCA Scan
    runs-on: ubuntu-latest
    needs: lint-check
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Snyk SCA scan
        run: snyk test --all-projects --severity-threshold=high

  snyk-sast:
    name: Snyk SAST Scan
    runs-on: ubuntu-latest
    needs: lint-check
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Snyk Code (SAST) scan
        run: snyk code test --severity-threshold=high

      - name: Monitor project in Snyk
        run: snyk monitor --all-projects

  test-and-coverage:
    name: Run Unit Tests & Upload Coverage
    runs-on: ubuntu-latest
    needs: [snyk-sca, snyk-sast]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Unit Tests and generate Jacoco report
        run: mvn clean verify

      - name: Upload Test Results & Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/
            **/target/site/jacoco/
            **/target/site/checkstyle.html
